const factories = require("../factories/index.js");
import Singleton from "../../src/singleton.js";
if (jest) jest.useFakeTimers();

const Test = {
  factories,
  fns: {},
};

Test.fns.defineSingleton = () => {
  Singleton.Page = {
    page: {},
    mountedModObjs: {},
    unmountedEls: [],
    modsWithRemainingAssets: [],
    modsWithoutRemainingAssets: [],
    mapMmos(cb) {
      if (!cb || typeof cb !== "function") return;
      this.mountedIds().map((id) => cb(this.mountedModObjs[id]));
    },
    mountedIds() {
      return Object.keys(this.mountedModObjs);
    },
    priorPages: [],
  };
  Singleton.Version = {
    currentVersion: "default",
  };
  Singleton.Opts = {};
  Singleton.Promise = Promise;
  Singleton.ready = (cb) => {
    if (cb && typeof cb === "function") cb();
    return Promise.resolve();
  };
};

Test.fns.fireAllScriptOnloads = (document) => {
  if (!document) return;
  const scripts = document.getElementsByTagName("script");
  for (let i = 0; i < scripts.length; i++) {
    if (scripts[i].onload) scripts[i].onload();
  }
};

Test.fns.fireAllLinkOnloads = (document) => {
  if (!document) return;
  const links = document.getElementsByTagName("link");
  for (let i = 0; i < links.length; i++) {
    if (links[i].onload) links[i].onload();
  }
};

Test.fns.fireAllOnloads = (document) => {
  Test.fns.fireAllLinkOnloads(document);
  Test.fns.fireAllScriptOnloads(document);
  if (jest) jest.runAllTimers();
};

if (window) Test.fns.defineSingleton();

export default Test;
