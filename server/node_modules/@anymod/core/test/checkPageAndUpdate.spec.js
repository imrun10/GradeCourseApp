import Test from "./config/test.utils.js";
import core from "../src/index.js";
const { Singleton, checkPageAndUpdate, crud } = core;

describe("checkPageAndUpdate", () => {
  beforeAll(() => {
    Test.fns.defineSingleton();
    document.head.innerHTML = Test.factories.document.headInnerHtml;
    Singleton.Page.page = Test.factories.pages.basic;
    Singleton.Opts.api = true;
    Singleton.ApiUrl = "https://example.com/";
  });

  it("should make a PUT request if a new mod is on the page", async () => {
    // Add a new mod to the page
    document.body.innerHTML = `<div id="anymod-${Test.factories.mods.plainjs.key}" data-key="${Test.factories.mods.plainjs.key}"></div>`;

    // Mock out the PUT request
    crud.put = jest.fn(async () => Singleton.Page.page);
    const page = await checkPageAndUpdate(Singleton.Page.page);
    expect(crud.put).toHaveBeenCalled();
    expect(page.id).toBe(1);
    expect(page.mods).toEqual({
      basic: Test.factories.mods.basic,
      assetboth: Test.factories.mods.assetboth,
    });
  });
});
