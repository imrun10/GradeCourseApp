import Singleton from "../src/singleton.js";
import alias from "../src/alias.js";

import { addScript1ToDocument } from "../src/page.crud.js";
import { ready } from "../src/mod.ready.js";

const aliasName = "SomeAlias";

describe("alias operations", () => {
  it("setAlias should include rq", () => {
    // Set up mock functions
    const mockA = jest.fn();
    const mockB = jest.fn();

    // Mimic setting from (m,o,d,u,l,a,r,i,z,e)
    window[aliasName] = {
      m: aliasName,
      o: "abcd1234",
      r: { custom: "option" },
      rq: [mockA, mockB],
    };

    // Set the alias
    alias.setAlias(aliasName);

    // Expect Singleton to be properly decorated
    expect(Singleton.Alias).toEqual(window[aliasName].m);
    expect(Singleton.Project).toEqual(window[aliasName].o);
    expect(Singleton.Opts.custom).toEqual(window[aliasName].r.custom);
    expect(Singleton.rq).toContain(mockA);
    expect(Singleton.rq).toContain(mockB);

    // Call addScript1ToDocument
    addScript1ToDocument();

    // Singleton should still contain the ready queue
    expect(Singleton.rq).toContain(mockA);
    expect(Singleton.rq).toContain(mockB);
    expect(mockA).not.toHaveBeenCalled();
    expect(mockB).not.toHaveBeenCalled();

    // Call ready
    ready();

    // Callbacks should be called
    expect(mockA).toHaveBeenCalled();
    expect(mockB).toHaveBeenCalled();
  });
});
