import Singleton from "./singleton.js";
import alias from "./alias.js";

const logErrorsAndTips = () => {
  logModErrors();
  logTips();
};

const logModErrors = () => {
  if (!Singleton.Page.page || !Singleton.Page.page.errorMessages) return;
  const errorKeys = Object.keys(Singleton.Page.page.errorMessages);
  const modText = "mod" + (errorKeys.length === 1 ? "" : "s");
  if (errorKeys.length < 1) return;
  console.log(
    "%c%s",
    "color: #ea8c01;background:#fcf8e3;font-size:13px;",
    "  Project " +
      Singleton.Project +
      ". " +
      errorKeys.length +
      " " +
      modText +
      " undeliverable for this page:  "
  );
  try {
    if (/^((?!chrome|android).)*safari/i.test(navigator.userAgent))
      throw new Error("Skip Safari for console.table"); // Bug: Safari throws iframe errors when console.table is used.
    console.table(Singleton.Page.page.errorMessages);
  } catch (err) {
    errorKeys.map((key, i) =>
      console.warn("" + i + ": " + key, Singleton.Page.page.errorMessages[key])
    );
  }
};

const logTips = () => {
  if (!Singleton.Opts.tips || !window.AnyModPageJs) return;
  let assetMessage = "";
  if (
    window.AnyModPageJs.cssAssetsToLog &&
    window.AnyModPageJs.cssAssetsToLog.length > 0
  ) {
    window.AnyModPageJs.cssAssetsToLog.map(
      (asset) => (assetMessage += `<link href="${asset}" rel="stylesheet">\n`)
    );
  }
  if (
    window.AnyModPageJs.jsAssetsToLog &&
    window.AnyModPageJs.jsAssetsToLog.length > 0
  ) {
    window.AnyModPageJs.jsAssetsToLog.map(
      (asset) => (assetMessage += `<script defer src="${asset}"></script>\n`)
    );
  }
  if (assetMessage) {
    console.log(
      `\nTo improve page speed, add the following to this page's HTML before the closing </head> tag:\n\n<!-- ${alias.name} assets -->
${assetMessage}<!-- /${alias.name} assets -->\n\n`
    );
  }
};

export { logErrorsAndTips };
