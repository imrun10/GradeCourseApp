import Singleton from "./singleton.js";
import "./alias.js";
import { createOrReturnPage, checkPageAndUpdate } from "./page.crud.js";
import { processPage } from "./page.process.js";
import utils from "./utils.js";

let renderChain = Promise.resolve();

const renderPromise = async (cb) => {
  const page = await createOrReturnPage();
  const updatedPage = await checkPageAndUpdate(page);
  await processPage(updatedPage);
  if (cb && typeof cb === "function") cb();
};

const render = (cb) => {
  utils.debugLog(["render() callback"]);
  Singleton.Page.modsMounted = [];
  return new Promise((resolve) => {
    if (!Singleton.ready) return resolve()
    Singleton.ready(() => {
      renderChain = renderChain.then(() => renderPromise(cb));
      resolve(renderChain);
    });
  });
};

export { renderPromise, render };
